---
import MainLayout from "../../../layouts/MainLayout.astro";
import { ResetPasswordForm } from "../../../components/auth/ResetPasswordForm";

// Force client-side rendering for this page
export const prerender = false;

// Pobierz błędy z URL params
const error = Astro.url.searchParams.get("error");
const errorCode = Astro.url.searchParams.get("error_code");
const errorDescription = Astro.url.searchParams.get("error_description");
const hasError = !!error;

// Jeśli kod błędu to otp_expired (wygaśnięcie linku) przekieruj na forgot-password
if (errorCode === "otp_expired") {
  return Astro.redirect("/auth/forgot-password?reason=expired");
}

// Próba pobrania tokenu z URL query params
const tokenFromQuery = Astro.url.searchParams.get("token") || "";
---

<MainLayout title="10x Cards - Resetowanie hasła">
  <!-- Skrypt pobierający token z hash URL -->
  <script src="/token-extractor.js" is:inline></script>

  <div class="container max-w-md mx-auto px-4 py-8">
    <div class="rounded-lg border border-border bg-card p-6 shadow-sm">
      {
        hasError ? (
          <div class="space-y-6">
            <div class="space-y-2 text-center">
              <h1 class="text-2xl font-bold">Nieprawidłowy link</h1>
              <p class="text-sm text-muted-foreground">Link do resetowania hasła jest nieprawidłowy lub wygasł</p>
            </div>

            <div class="rounded-md bg-destructive/15 p-3 text-sm text-destructive">
              {errorDescription
                ? errorDescription.replace(/\+/g, " ")
                : "Link do resetowania hasła jest nieprawidłowy lub wygasł"}
            </div>

            <div class="flex justify-center">
              <a
                href="/auth/forgot-password"
                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2"
              >
                Wyślij nowy link
              </a>
            </div>
          </div>
        ) : (
          <ResetPasswordForm client:load token={tokenFromQuery} />
        )
      }
    </div>
  </div>
</MainLayout>
